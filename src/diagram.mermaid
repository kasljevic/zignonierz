graph TD
    A[ğŸ› Initialize System] --> B[ğŸ”² Create Button Frame]
    B --> C[ğŸ”§ Set Default Button Attributes]
    C --> D[â° Initialize Metronome<br><i>(Periodically checks every 5s)</i>]
    D --> E[ğŸ” Run <b>smart_find_target</b> Function<br><i>(Find the best target)</i>]

    E --> F{ğŸ‘¥ Is the player in a group?}
    F -->|âœ… Yes| G[ğŸ‘€ Iterate through Group Members<br><i>(Checking each member)</i>]
    F -->|âŒ No| H[ğŸ¾ Check Pet Fallback<br><i>(If no group, check for pets)</i>]

    G --> I{ğŸ›¡ï¸ Is this a tank?}
    I -->|âœ… Yes| J{ğŸ“Š Does the tank meet the criteria?<br><i>(i.e., has certain buffs, is alive)</i>}
    I -->|âŒ No| G[ğŸ”„ Continue iterating group members]
    
    J -->|âœ… Yes| K[ğŸ¯ Set this tank as the target]
    J -->|âŒ No| G[ğŸ”„ Continue iterating group members]

    H --> L{ğŸ¾ Is a pet available?<br><i>(Check if the player has a valid pet)</i>}
    L -->|âœ… Yes| M[ğŸ¾ Set the pet as the target]
    L -->|âŒ No| N[ğŸ”„ Use Default Target<br><i>(Fallback to a predefined unit)</i>]

    K --> O[ğŸ› Update Button Attributes<br><i>(Target set, update button for use)</i>]
    M --> O
    N --> O

    P[ğŸ› End <b>smart_find_target</b> Function] --> Q[ğŸ”„ Handle Events<br><i>(e.g., group changes, combat status)</i>]
    Q --> R{ğŸ”„ Is an update required?<br><i>(Changes in group, pets, etc.)</i>}
    R -->|âœ… Yes| S{âš”ï¸ Is the player in combat?}
    S -->|âŒ No| E[ğŸ”„ Re-run <b>smart_find_target</b> Immediately]
    S -->|âœ… Yes| T[â¸ Wait until combat ends<br><i>(Delay update until after combat)</i>]
    R -->|âŒ No| U[â¹ No action required]

    T --> E[ğŸ”„ Re-run <b>smart_find_target</b> After combat]

    V[â° Metronome] --> W{âš ï¸ Is the update flag set?}
    W -->|âœ… Yes| E[ğŸ”„ Re-run <b>smart_find_target</b>]
    W -->|âŒ No| V[â° Wait for the next 5s check]
